<View style={styles.iconRow}>
          {!isGuest && (
            <TouchableOpacity onPress={() => setShowTrips(true)} style={styles.headerBtn}>
              <MaterialCommunityIcons name="bell-outline" size={24} color="#2563eb" />
              {bellCount > 0 && (
                <View style={styles.bellBadge}>
                  <Text style={styles.bellBadgeText}>{bellCount}</Text>
                </View>
              )}
            </TouchableOpacity>
          )}
          {!isGuest && (
            <TouchableOpacity style={styles.headerBtn}>
              <Ionicons name="person-circle-outline" size={24} color="#2563eb" />
            </TouchableOpacity>
          )}
          {!isGuest && (
            <TouchableOpacity onPress={onLogout} style={styles.headerBtn}>
              <Feather name="log-out" size={24} color="#2563eb" />
            </TouchableOpacity>
          )}
          <TouchableOpacity style={styles.headerBtn}>
            <Feather name="settings" size={24} color="#2563eb" />
          </TouchableOpacity>
        </View>







export default function HomeScreen({
  userPhone,
  isGuest = false,
  personalId,
  onNavigate,
  onLogout,
}: HomeScreenProps) {
  // const [personalId, setPersonalId] = useState<string | null>(null);
  const [fullName, setFullName] = useState<string | null>(null);
  const [mobile, setMobile] = useState<string | null>(null);
  const [email, setEmail] = useState<string | null>(null);

  const [tripDraft, setTripDraft] = useState<any>(null);
  const [trips, setTrips] = useState<TripItem[]>([]);
  const [showTrips, setShowTrips] = useState(false);

  useEffect(() => {
    (async () => {
      const s = await getSession();
      const pid = await getUserItem("pid_personal_id", s);
      const name = await getUserItem("pid_full_name", s);
      const mob = await getUserItem("pid_mobile", s);
      const mail = await getUserItem("pid_email", s);

      // setPersonalId(pid);
      setFullName(name);
      setMobile(mob);
      setEmail(mail);

      const d = readTripDraft();
      if (d && (d.endDate || d.destination || d.itinerary || d.mode)) setTripDraft(d);
    })();
  }, []);

  useEffect(() => {
    if (isGuest) return;
    (async () => {
      try {
        const data = await getMyTrips();
        setTrips(data?.trips || []);
      } catch {}
    })();
  }, [isGuest]);

  const sectionIcons: any = {
    "personal-id": <Feather name="shield" size={24} color="#fff" />,
    "plan-journey": <Feather name="map-pin" size={24} color="#fff" />,
    "personal-safety": <Feather name="heart" size={24} color="#fff" />,
    feedback: <Feather name="message-square" size={24} color="#fff" />,
    leaderboard: <FontAwesome name="trophy" size={24} color="#fff" />,
  };


  const hasPid = !!personalId;
  const sections = [
    {
      id: "personal-id",
      title: hasPid ? "View Personal ID" : "Create Personal ID",
      description: hasPid
        ? "Show and share your secure digital personal ID"
        : "Verify your identity for secure travel",
      icon: "personal-id",
      status: isGuest ? "disabled" : "available",
      color: "#246BFD",
      badge: hasPid ? null : isGuest ? null : "Required",
    },
    {
      id: "plan-journey",
      title: "Plan Journey",
      description: "Discover safe travel routes and destinations",
      icon: "plan-journey",
      status: "available",
      color: "#22c55e",
      badge: tripDraft ? "Draft" : null,
    },
    {
      id: "personal-safety",
      title: "Personal Safety",
      description: "Emergency contacts and safety preferences",
      icon: "personal-safety",
      status: isGuest ? "limited" : "available",
      color: "#ef4444",
      badge: null,
    },
    {
      id: "feedback",
      title: "Feedback",
      description: "Share your travel experiences",
      icon: "feedback",
      status: "available",
      color: "#facc15",
      badge: null,
    },
    {
      id: "leaderboard",
      title: "Leaderboard",
      description: "View safety achievements and rewards",
      icon: "leaderboard",
      status: isGuest ? "view-only" : "available",
      color: "#3b82f6",
      badge: null,
    },
  ];

  // const hasPid = Boolean(personalId);
  const visibleSections = hasPid ? sections.filter((sx) => sx.id !== "personal-id") : sections;

  const resumeTrip = () => onNavigate("plan-journey");
  const clearTrip = () => {
    clearTripDraft();
    setTripDraft(null);
  };

  const active = trips.filter((t) => t.status === "active");
  const upcoming = trips.filter((t) => t.status === "scheduled");
  const bellCount = active.length + upcoming.length;

const handleSectionClick = (id: string, status: string) => {
    if (status === "disabled") return;
    if (id === "personal-id") {
      onNavigate("personal-id");
      return;
    }
    onNavigate(id);
  };

  const copy = async (value?: string | null) => {
    if (!value) return;
    if (Platform.OS === "web") {
      try {
        await navigator.clipboard.writeText(value);
        alert("Copied!");
      } catch {}
    } else {
      // Use expo-clipboard in real app
      try {
        alert("Copied! (add Clipboard support here)");
      } catch {}
    }
  };

  return (
    <SafeAreaView style={{ flex: 1, backgroundColor: "#f9fafb" }} edges={["top", "left", "right"]}>
      <View style={styles.header}>
        <View>
          <Text style={styles.title}>SaFara</Text>
          <Text style={styles.subtitle}>
            {isGuest ? "Guest Mode" : `Welcome, +91 ${userPhone}`}
          </Text>
        </View>
        
      </View>

      {isGuest && (
        <View style={styles.guestBanner}>
          <Text style={styles.guestText}>
            [translate:Sign in to access Personal ID and full safety tools.]
          </Text>
        </View>
      )}

      <ScrollView style={styles.content} contentContainerStyle={{ paddingBottom: 100 }}>
        {/* {hasPid && (
          <Card style={{ marginBottom: 24 }}>
            <View style={styles.cardHeader}>
              <Text style={styles.cardTitle}>Digital Personal ID</Text>
              <Badge variant="secondary" style={styles.badgeVerified}>
                <Feather name="check-circle" size={16} color="#22c55e" />
                <Text style={styles.verifiedText}>Verified</Text>
              </Badge>
            </View>
            <View style={styles.infoGrid}>
              <View style={styles.infoRow}>
                <Text style={styles.infoLabel}>Personal ID</Text>
                <View style={styles.infoValueRow}>
                  <Text style={styles.infoValue}>{personalId}</Text>
                  <TouchableOpacity onPress={() => copy(personalId)}>
                    <Feather name="copy" size={16} color="#246BFD" />
                  </TouchableOpacity>
                </View>
              </View>
              <View style={styles.infoRow}>
                <Text style={styles.infoLabel}>Name</Text>
                <Text style={styles.infoValue}>{fullName || "—"}</Text>
              </View>
              <View style={styles.infoRow}>
                <Text style={styles.infoLabel}>Mobile</Text>
                <Text style={styles.infoValue}>{mobile || userPhone || "—"}</Text>
              </View>
              <View style={styles.infoRow}>
                <Text style={styles.infoLabel}>Email</Text>
                <Text style={styles.infoValue}>{email || "—"}</Text>
              </View>
            </View>
            <View style={styles.buttonRow}>
              <Button variant="outline" onPress={() => onNavigate("verify-identity")}>
                Show QR
              </Button>
              <Button variant="secondary" onPress={() => onNavigate("personal-id-details")}>
                View details
              </Button>
            </View>
          </Card>
        )} */}

        
        
        <View>
          <Text style={styles.sectionTitle}>Travel Safety Hub</Text>
          {visibleSections.map((section) => {
            return (
              <TouchableOpacity
                key={section.id}
                style={[
                  styles.sectionCard,
                  { backgroundColor: "#fff" },
                  section.status === "disabled" && styles.disabledCard,
                ]}
                onPress={() => handleSectionClick(section.id, section.status)}
                disabled={section.status === "disabled"}
              >
                <View style={styles.sectionInnerRow}>
                  <View style={[styles.iconBox, { backgroundColor: section.color }]}>
                    {sectionIcons[section.icon]}
                  </View>
                  <View style={styles.sectionTextContainer}>
                    <View style={styles.sectionTitleRow}>
                      <Text style={styles.sectionTitleText}>{section.title}</Text>
                      {section.badge && <Badge variant="secondary">{section.badge}</Badge>}
                      {section.status === "disabled" && (
                        <Badge variant="destructive">Login Required</Badge>
                      )}
                      {section.status === "limited" && (
                        <Badge variant="outline">Limited Access</Badge>
                      )}
                      {section.status === "view-only" && (
                        <Badge variant="outline">View Only</Badge>
                      )}
                    </View>
                    <Text style={styles.sectionDescription}>{section.description}</Text>
                  </View>
                  <Feather name="chevron-right" size={24} color="#6b7280" />
                </View>
              </TouchableOpacity>
            );
          })}
        </View>
        <Card style={{ marginTop: 24, marginBottom: 64 }}>
          <Text style={styles.tipTitle}>Safety Tip of the Day</Text>
          <Text style={styles.tipText}>
            [translate:Always inform a trusted contact about your travel plans and expected return time.]
          </Text>
        </Card>
      </ScrollView>

      {/* Trips "Dialog" */}
      <Modal visible={showTrips} animationType="fade" transparent onRequestClose={() => setShowTrips(false)}>
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={{ fontWeight: "700", fontSize: 17, marginBottom: 12 }}>Your trips</Text>
            <ScrollView style={{ maxHeight: 300 }}>
              {[...active, ...upcoming].map((t) => (
                <View key={t.tid} style={styles.tripItem}>
                  <View style={styles.tripItemHeader}>
                    <Text style={styles.tripItemTitle}>{t.destination || "Undisclosed"}</Text>
                    <Badge variant={t.status === "active" ? "secondary" : "outline"}>
                      {t.status}
                    </Badge>
                  </View>
                  <Text style={styles.tripItemDetails}>
                    {t.startDate} → {t.endDate} • {t.travelerType.toUpperCase()}
                  </Text>
                  <Text style={styles.tripId}>TID: {t.tid}</Text>
                </View>
              ))}
              {active.length === 0 && upcoming.length === 0 && (
                <Text style={styles.noTripText}>No active or upcoming trips.</Text>
              )}
            </ScrollView>
            <Button
              onPress={() => setShowTrips(false)}
              variant="secondary"
            >
              Close
            </Button>
          </View>
        </View>
      </Modal>
    </SafeAreaView>
  );
}